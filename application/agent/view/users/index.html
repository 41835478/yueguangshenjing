<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> - 用户列表</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    {include file="public/header"}
    <link href="__PUBLIC__/admin/css/plugins/jsTree/style.min.css" rel="stylesheet">
</head>
<body class="gray-bg">
{include file="public/popBox"}
<div class="col-sm-12">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>用户列表</h5>
            <div class="ibox-tools">
                <!--<a class="collapse-link" href="javascript:;">-->
                <!--<button type="button" class="btn btn-outline btn-success" data-toggle="modal" data-target="#myModal5">-->
                <!--</button>-->
                <!--</a>-->
            </div>
        </div>
        <div class="ibox-content">
            <form action="{:url('users/index')}" method="get">
                <div class="input-group">
                    <span style="float: right;margin-left: 10px;margin-right: 10px">
                                <input placeholder="结束日期" value=""
                                       onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})"
                                       class="input-sm form-control layer-date" name="end" id="end">
                            </span>
                    <span style="float: right;margin-left: 10px">
                                <input placeholder="开始日期" value=""
                                       onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})"
                                       class="input-sm form-control layer-date" name="start" id="start">
                            </span>
                    <span style="float: right;margin-left: 5px;">级别：
                        <select id="threeLevel" name="level" class="input-sm">
                            <option value="">--请选择--</option>
                            <option value="1">普通会员</option>
                            <option value="2">消费会员</option>
                            <option value="3">县级市代理</option>
                            <option value="4">地级市代理</option>
                            <option value="5">省会城市代理</option>
                            <option value="6">一线城市代理</option>
                            <option value="7">店面</option>
                        </select>
                    </span>
                    <span style="float: right;margin-left: 5px;">推荐人：
                        <input name="from_phone" type="text" class="input-sm" placeholder="请输入推荐人电话"/>
                    </span>
                    <span style="float: right;margin-left: 5px;">用户昵称：
                        <input name="nickname" type="text" class="input-sm" placeholder="请输入用户昵称"/>
                    </span>
                    <span style="float: right;margin-left: 5px;">用户手机号：
                        <input name="mobile" type="text" class="input-sm" placeholder="请输入用户手机号"/>
                    </span>
                    <span class="input-group-btn">
                        <button type="submit" class="btn btn-sm btn-primary">
                            搜索
                        </button>
                    </span>
                </div>
            </form>
            <table class="footable table table-stripped" data-page-size="10" data-filter=#filter>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>推荐人手机号</th>
                    <th>会员昵称</th>
                    <th>会员手机号</th>
                    <th>会员注册时间</th>
                    <th>会员余额</th>
                    <th>会员等级</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {foreach $users as $v}
                <tr class="gradeX">
                    <td class="did">{$v->id}</td>
                    <td>{$v->pid == "" ? "系统" : $v->pid}</td>
                    <td>{$v->nickname}</td>
                    <td>{$v->mobile}</td>
                    <td>{$v->created_at}</td>
                    <td>{$v->account}</td>
                    <td>{$v->level}</td>
                    <td>
                        <a href="javascript:void(0)" onclick="editLevel('{$v->id}','{$v->level}')"
                           data-toggle="modal" data-target="#myModal5">修改店面</a>
                        <a href="javascript:void(0)" onclick="childen('{$v->id}')">
                            {$v->downUser($v->id) == "" ? "没有下级" : "查看下级"}</a>
                    </td>
                </tr>
                <input type="hidden" id="area_{$v->id}" value="{$v->area}">
                {/foreach}

                </tbody>
                <tfoot>
                <tr>
                    <td colspan="3">
                        总共 {$total}页 当前显示第 {$currentPage} 页
                    </td>
                    <td colspan="13" style="text-align: right">
                        {$render}
                    </td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="modal inmodal fade" id="myModal5" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">修改会员等级</h4>
                <small class="font-bold">这里可以显示副标题。</small>
            </div>
            <div class="modal-body">
                <select class="sel123" id="level" name="level" class="input-sm">
                    <option value="7">一级店面</option>
                    <option value="8">二级店面</option>
                </select>
                <div style="width:420px;margin-top: 20px;display: none;" class="sanLinks">
                    <input type="text" id="shop_name" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" onclick="submitLevel()" class="btn btn-primary" id="level_ss">保存</button>
            </div>
        </div>
    </div>
</div>
{include file="public/foot"}

</body>
<script>
    var user_id = "";
    function editLevel(id) {
        $.ajax({
            url:"{:url('users/userOne')}",
            type:"get",
            data:{
                id:id
            },success:function(res){
                if(res.status == 0){
                    console.log(res);
                    $("#level").val(res.data.level);
                    $("#city").val(res.data.area);
                    $("#shop_name").val(res.data.shop_name);
                    if(res.data.level == 7 || res.data.level == 8){
                        $(".sanLinks").css("display","block");
                    }else{
                        $(".sanLinks").css("display","none");
                    }
                }else{
                    alert(res.msg);
                }
            }
        });

        user_id = id;
    }
    function submitLevel() {
        if($("#shop_name").val() == ""){
            alert("请填写店面名称");
            return;
        }
        if(confirm("确定修改该店面?")){
            $.ajax({
                url:"{:url('users/editStorefront')}",
                type:"post",
                data:{
                    id:user_id,
                    shop_name:$("#shop_name").val(),
                    level:$("#level").val()
                },success:function(res){
                    if(res.status == 0){
                        history.go(0);
                    }
                    if(res.status == 100){
                        alert(res.msg);
                    }
                }
            });
        }
    }
    //用户下级
    function childen(id){
        //加载层
        index2 = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2

        //获取权限信息
        $.ajax({
            url:"{:url('users/suborDinate')}",
            type:"get",
            data:{
                id:id
            }, success:function(res){
                layer.close(index2);
                if(res.message){
                    layer.msg(res.message);
                    return;
                }
                layer.open({
                    type: 1,
                    shade: 0,
                    maxmin: true,//允许最大化
                    resize: true,//允许拉伸
                    offset: [ //随机坐标
                        Math.random()*($(window).height()-500)
                        ,Math.random()*($(window).width()-600)
                    ],
                    zIndex: 9, //重点1
                    success: function(layero){
                        layer.setTop(layero); //重点2
                    },
                    tipsMore: true,
                    area:['600px', '500px'],
                    title:'<b style="color:orange;">'+res.user.name+'</b>的下级　　人数：<b style="color:orange;">'+res.num+'</b>人',
                    skin: 'layui-layer-demo', //加上边框
                    content: res.data
                });
            },error:function(){
                console.log("请稍后重试");
            }
        });
    }
</script>
</html>